{% extends 'global/base.html' %}
{% load static widget_tweaks %}

{% block title %} Agendar Formatura {% endblock %}

{% block content %}

<div class="container mt-5">

    <h1 class="mb-4 text-primary fw-bold text-center">Agendar Formatura</h1>

    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- ============== FORM DADOS FORMATURA ================= -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white fw-semibold">
                Dados da Formatura
            </div>
            <div class="card-body">
                <div class="row g-3">
                    {% for field in form %}
                        <div class="col-md-6">
                            <label class="form-label">{{ field.label }}</label>
                            {% if field.field.widget.input_type == "checkbox" %}
                                <div class="form-check form-switch">
                                    {{ field|add_class:"form-check-input" }}
                                    <label class="form-check-label" for="{{ field.id_for_label }}">Publicado</label>
                                </div>
                            {% else %}
                                {{ field|add_class:"form-control" }}
                            {% endif %}
                            {% for error in field.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- ============== PONTOS DE AGENDA LISTA ================= -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-secondary text-white fw-semibold d-flex justify-content-between">
                <span>Pontos de Agenda</span>
                <button type="button" class="btn btn-light btn-sm fw-bold" data-bs-toggle="modal" data-bs-target="#agendaModal">
                    + Adicionar Ponto
                </button>
            </div>
            <div class="card-body">
                {{ formset.management_form }}
                <div id="hiddenForms" style="display: none;"></div>

                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Ordem</th>
                            <th>Título</th>
                            <th>Departamento</th>
                            <th>Responsável</th>
                            <th>Status</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="agendaTableBody">
                        {% for f in formset %}
                        <tr class="agenda-row">
                            <td>{{ f.instance.ordem }}</td>
                            <td>{{ f.instance.titulo }}</td>
                            <td>{% if f.instance.departamento %}{{ f.instance.departamento.nome }}{% else %}-{% endif %}</td>
                            <td>{% if f.instance.responsavel %}{{ f.instance.responsavel.get_full_name }}{% else %}-{% endif %}</td>
                            <td>{{ f.instance.get_status_display }}</td>
                            <td>
                                {% if formset.can_delete %}
                                    <button type="button" class="btn btn-sm btn-danger removeRow">Remover</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="text-center mb-4">
            <button class="btn btn-success btn-lg px-5">Salvar Formatura</button>
        </div>
    </form>
</div>

<!-- ============================ -->
<!-- Modal: Add Ponto Agenda     -->
<!-- ============================ -->
<div class="modal fade" id="agendaModal" tabindex="-1"
     data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title">Adicionar Ponto de Agenda</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label">Ordem</label>
                        {{ formset.empty_form.ordem|add_class:"form-control" }}

                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Departamento</label>
                       {{ formset.empty_form.departamento }}
                       


                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Responsável</label>
                        {{ formset.empty_form.responsavel|add_class:"form-select" }}
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Título</label>
                        {{ formset.empty_form.titulo|add_class:"form-control" }}
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Descrição</label>
                        {{ formset.empty_form.descricao|add_class:"form-control" }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Status</label>
                        {{ formset.empty_form.status|add_class:"form-select" }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Prioridade</label>
                        {{ formset.empty_form.prioridade|add_class:"form-select" }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Data Limite</label>
                        {{ formset.empty_form.data_limite|add_class:"form-control" }}
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" id="addAgendaBtn" class="btn btn-primary">Adicionar</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let totalForms = document.getElementById("id_{{ formset.prefix }}-TOTAL_FORMS");

    const addBtn = document.getElementById("addAgendaBtn");
    const modal = document.getElementById("agendaModal");

    addBtn.addEventListener("click", function () {
        let index = totalForms.value;
        let wrapper = document.createElement("div");
        wrapper.innerHTML = `{{ formset.empty_form.as_p|escapejs }}`.replace(/__prefix__/g, index);

        // Pega os valores do modal
        let ordem = document.querySelector('#agendaModal [name$="ordem"]').value;
        let titulo = document.querySelector('#agendaModal [name$="titulo"]').value;
        let responsavel = document.querySelector('#agendaModal [name$="responsavel"]').value;
        let responsavelText = document.querySelector('#agendaModal [name$="responsavel"] option:checked').text;
        let departamento = document.querySelector('#agendaModal [name$="departamento"]').value;
        let departamentoText = document.querySelector('#agendaModal [name$="departamento"] option:checked').text;
        let status = document.querySelector('#agendaModal [name$="status"]').value;
        let prioridade = document.querySelector('#agendaModal [name$="prioridade"]').value;
        let data_limite = document.querySelector('#agendaModal [name$="data_limite"]').value;

        // Preenche o form invisível
        wrapper.querySelector(`[name$="ordem"]`).value = ordem;
        wrapper.querySelector(`[name$="titulo"]`).value = titulo;
        wrapper.querySelector(`[name$="responsavel"]`).value = responsavel;
        wrapper.querySelector(`[name$="departamento"]`).value = departamento;
        wrapper.querySelector(`[name$="status"]`).value = status;
        wrapper.querySelector(`[name$="prioridade"]`).value = prioridade;
        wrapper.querySelector(`[name$="data_limite"]`).value = data_limite;

        document.getElementById("hiddenForms").appendChild(wrapper);

        // Adiciona linha visível à tabela
        let row = document.createElement("tr");
        row.className = "agenda-row";
        row.innerHTML = `
            <td>${ordem}</td>
            <td>${titulo}</td>
            <td data-id="${departamento}">${departamentoText}</td>
            <td data-id="${responsavel}">${responsavelText}</td>
            <td>${status}</td>
            <td><button type="button" class="btn btn-danger btn-sm removeRow">X</button></td>
        `;
        document.getElementById("agendaTableBody").appendChild(row);

        totalForms.value = Number(totalForms.value) + 1;

        bootstrap.Modal.getInstance(modal).hide();
    });

    document.addEventListener("click", function (e) {
        if (e.target.classList.contains("removeRow")) {
            e.target.closest("tr").remove();
            // Atualiza totalForms se necessário
            totalForms.value = document.querySelectorAll(".agenda-row").length;
        }
    });
});

$('#agendaModal').on('shown.bs.modal', function () {
    $(this).find('select').each(function () {
        if (!$(this).hasClass('select2-hidden-accessible')) {
            $(this).djangoSelect2();
        }
    });
});
</script>




{% endblock %}
